<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>No Context</title>
  <style>
  @import url(http://fonts.googleapis.com/css?family=Roboto:400,300);
  body{
    margin: 0;
    padding: 0;
    background: #000;
  }
  img {
    height: 100px;
    float: left;
  }
@keyframes loading {
    from{
       transform: rotate(0deg);
        -webkit-transform: rotate(0deg);
        -moz-transform: rotate(0deg);
        -webkit-transform: rotate(0deg);
        -o-transform: rotate(0deg);
        -ms-transform: rotate(0deg);
    }
    to{
         transform: rotate(360deg);
        -webkit-transform: rotate(360deg);
        -moz-transform: rotate(360deg);
        -webkit-transform: rotate(360deg);
        -o-transform: rotate(360deg);
        -ms-transform: rotate(360deg);
    }
}
@-webkit-keyframes loading /* Safari and Chrome */ {
  from {
    transform: rotate(0deg);
    -ms-transform: rotate(0deg);
    -moz-transform: rotate(0deg);
    -webkit-transform: rotate(0deg);
    -o-transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
    -ms-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -o-transform: rotate(360deg);
  }
}
  #loading{
    position: absolute;
   top: 10px;
   left: 10px;
   width: 20px;
   height: 20px;
   background: #fff;
  -webkit-animation: loading 2s linear infinite;
  -moz-animation: loading 2s linear infinite;
  -ms-animation: loading 2s linear infinite;
  -o-animation: loading 2s linear infinite;
  -animation: loading 2s linear infinite;

  }

  #wrapper{
    width: 100%;
    min-height: 800px;
    text-align: center;
    position: absolute;
    z-index: -10;
    top: 0;
    margin: 0px auto;
    display: block;
    -webkit-filter: blur(7px);
    -moz-filter: blur(7px);
    -o-filter: blur(7px);
    -ms-filter: blur(7px);
    filter: blur(7px);
  }
  #content{
    padding: 20px;
    font-family: 'Roboto', sans-serif;
    width: 80%;
    border-radius: 3px;
    margin: 15% auto;
    text-align: center;
    display: none;
  }
  #content h1{
    font-family: 'Roboto', sans-serif;
    font-size: 36px;
    margin-top: 0px;
    color: #fff;
    text-shadow:0 0 3px #000;
    -moz-text-shadow:0 0 3px #000;
    -webkit-text-shadow:0 0 3px #000;
    -webkit-font-smoothing: antialiased;
  }
  #content a{
    font-style: italic;
    font-size: 12px;
    text-decoration: none;
    color: #FF4C4C;
  }
  #content a:hover{
    color:#F28379;
  }
 
  .nav a{
    display: inline-block;
    padding: 20px 200px;
    font-size: 1.3em;
    font-family: 'Roboto', sans-serif;
    text-decoration: none;
    color: #2A4B8C;
    margin: 5px;
    background: rgba(255, 255, 255, .8);
  }
  .nav a:hover{
    color:#FF4C4C;
    background: rgba(0, 0, 0, .8);
  }
  footer{
    text-align: center;
    bottom: 0px;
    position: fixed;
    width: 100%;
    /*margin-bottom: 30px;*/
  }
  @media (max-width: 700px) { 
    .nav a{
      padding: 20px 50px;
      font-size: 1em;
    }
  }
  </style>
  <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script type="text/javascript" src="query-string/query-string.js"></script>
  <meta name="viewport" content="width=device-width">
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-24156444-1', 'imnotdannorton.com');
  ga('send', 'pageview');

</script>
</head>
<body>

<div id='loading'></div>
 <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=477453389032108";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



<div id="wrapper">
 </div>
<div id="content">
</div>

<footer class='nav'><a href="#" class="prev">&laquo; Prev</a> <a href="#" class="next">Next &raquo;</a></footer>


<script>
//var main = {};
var posts = [];
var currentPost = 0;
var googleImgQuery = "https://ajax.googleapis.com/ajax/services/search/images?v=1.0&as_filetype=gif&imgtype=animated&tbs=itp:animated&callback=?&q=";
var staticImgQuery = "https://ajax.googleapis.com/ajax/services/search/images?v=1.0&callback=?&q=";

var sub = '';
var postId = '';
var activePost = 0;
 
  if(getParameterByName('r') != ''){
    sub = getParameterByName('r');
    //console.log()
  }else{
    sub = 'topgear';
  }
  if(getParameterByName('post') != ''){
    postId = getParameterByName('post');
    console.log(postId);
  }

function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}
function getPosts() {
 
  var reddit = "http://www.reddit.com/r/"+ sub +"/new.json?sort=new";

  $.getJSON(reddit, function( data ) { 
    posts = data.data.children; 
    console.log(posts);
    if (postId != ''){
      activePost = search(postId, 'posts');
      if(!activePost){
        getPost(postId);
      } else {
        renderPost(activePost);
      }
    }
    
  });

  $("footer a").on('click', newPost);
}

function getPost(id) {
 
  var reddit = "http://www.reddit.com/r/"+ sub +"/"+id+".json";

  $.getJSON(reddit, function( data ) { 
    console.log(data[0]);
    post = data[0].data.children; 
    if (postId != ''){
      activePost = post[0];
      renderPost(activePost);
    }
  });

}

function search(nameKey, myArray){
    for (var i=0; i < posts.length; i++) {
        if (posts[i].data.id === nameKey) {
            console.log(i);
            return i;
        }
    }
    return false;
}
function renderPost(id){
    imgBg(posts[id].data.title);
    mydate = posts[24].data.created_utc;
    date = new Date(mydate*1000);

    link = "http://reddit.com" + posts[id].data.permalink; 
    $("#content").html("<h1>"+posts[id].data.title+"</h1><a href='"+ link +"'>- " + posts[id].data.author+ " - " + date.toString().slice(0,15) + "</a>");
    $("#content").css('display', 'none').fadeIn("slow");
  if(id == posts.length-1){
      $(".next").hide();
   }else{
      $(".next").show();
   }
   if(id == 0){
      $(".prev").hide();
   }else{
      $(".prev").show();
   }
   //updateUrl();
}
function updateUrl(newPost){
  var url = window.location.href.split('?');
  var parsed = queryString.parse(url[1]);
  console.log(parsed);
// {foo: 'bar'
parsed.r = sub;
parsed.post = newPost;
console.log(url[0] + '?' + queryString.stringify(parsed));
window.location.assign(url[0] + '?' + queryString.stringify(parsed))
// http://sindresorhus.com?foo=unicorn&ilike=pizza
}
$(document).keydown(function(e){
    if (e.keyCode == 39) { 
      activePost++;
      updateUrl(posts[activePost].data.id);
    }
     if (e.keyCode == 37) { 
        if (activePost > 0){
          activePost--;
        };
      updateUrl(posts[activePost].data.id);
    }
});
function newPost(e){
        //e.preventDefault();
        //console.log(e.target);
        if ($(e.target).attr('class') == 'next'){
          activePost++;
        }
        if ($(e.target).attr('class') == 'prev') {
          if (activePost > 0){
          activePost--;
          };
        };
        updateUrl(posts[activePost].data.id);
}
function imgBg(query){
  var imageReq = googleImgQuery+escape(query);
  var imageReqStatic = staticImgQuery+escape(query);
  var imgResult = '';
  $.getJSON(imageReq, function( data ) { 
    // TODO: return image, if it returns null, use static image request
    console.log(data);
    if (data.responseData == null || data.responseData.results.length == 0){
       staticRequest();
    }else{    
      imgResult = data.responseData.results[0].unescapedUrl;
      $('#loading').hide();
      $("#wrapper").css({'background':'url(' + imgResult + ') no-repeat top center', 'display':'none', 'background-size':'cover'}).fadeIn(300); 
    }
  });
  function staticRequest(){
    $.getJSON(imageReqStatic, function( data ) { 
           if (data.responseData == null || data.responseData.results.length == 0) {
            imgResult = 'fallback.jpg';
           }else{
            imgResult = data.responseData.results[0].unescapedUrl;
          }
          $('#loading').hide();
          console.log('static!!!');
          $("#wrapper").css({'background':'url(' + imgResult + ') no-repeat top center', 'display':'none', 'background-size':'cover'}).fadeIn(300); 
       });
  }
}
$(document).ready(getPosts());
</script>
 
</body>
</html>